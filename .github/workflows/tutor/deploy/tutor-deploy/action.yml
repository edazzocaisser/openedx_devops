#------------------------------------------------------------------------------
# written by: mcdaniel
# date: feb-2022
#
# see:
# https://docs.github.com/en/actions/using-workflows/reusing-workflows
# https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#onworkflow_callinputs
# https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#onworkflow_callsecrets
#------------------------------------------------------------------------------
name: Deploy to Kubernetes
description:
branding:
  icon: 'cloud'
  color: 'orange'
  inputs:
    environment-id:
      description: 'The Open edX platform environment. Examples: prod, qa, dev'
      required: true
      type: string
    namespace:
      description: 'The Kubernetes namesapce to which the Open edX platform environment will be deployed. Example: openedx-prod'
      required: true
      type: string
    openedx-common-version:
      description: 'The named release of Open edX platform to deploy. Example: open-release/maple.3'
      required: true
      type: string
    aws-ses-iam-key:
      description: 'AWS SES IAM key'
      required: false
      default: 'SET-ME-PLEASE'
    aws-ses-iam-secret:
      description: 'AWS SES IAM secret'
      required: false
      default: 'SET-ME-PLEASE'
runs:
  using: "composite"
  env:
    ENVIRONMENT_ID: prod
    NAMESPACE: openedx-prod
    OPENEDX_COMMON_VERSION: open-release/maple.3

  steps:
    - name: Checkout
      uses: actions/checkout@v3.0.2

    - name: Initialize environment
      uses: ./.github/workflows/tutor/deploy/tutor-deploy-init
      with:
        environment-id: prod
        namespace: openedx-prod
        openedx-common-version: open-release/maple.3

    - name: Enable Tutor plugins
      uses: ./.github/workflows/tutor/deloy/plugins/tutor-enable-plugins
      with:
        tutor-enable-plugin-s3: false
        tutor-enable-plugin-backup: false
        tutor-enable-plugin-discovery: false
        tutor-enable-plugin-mfe: false
        tutor-enable-plugin-credentials: false
        tutor-enable-plugin-xqueue: false
        tutor-enable-plugin-notes: false
        tutor-enable-plugin-ecommerce: false
        tutor-enable-plugin-forum: false

    # note that the Kubernetes additional config data is locally
    # stored in ci/tutor-deploy/environments/prod/k8s/
    # in Kubernetes manifest yaml format
    - name: Create Kubernetes add-on resources
      run:  |-
        # Create kubernetes ingress and other environment resources
        kubectl apply -f "ci/tutor-deploy/environments/$ENVIRONMENT_ID/k8s"


    # ---------------------------------------------------------------------------------
    # Note: We're not managing AWS SES with Terraform simply because the service is fiddly
    # and AWS is neurotic about any changes to the config.
    # ---------------------------------------------------------------------------------
    - name: Setup AWS SES over SMTP
      uses: ./.github/workflows/tutor/deploy/backend/tutor-configure-smtp
      with:
        aws-ses-iam-key: ${{ secrets.aws-ses-iam-key }}
        aws-ses-iam-secret: ${{ secrets.aws-ses-iam-secret }}


    #------------------------------------------------------------------------
    # IV. Merge all of the configuration data into Tutor's Open edX
    #     configuration files: config.yml, lms.env.json, cms.env.json
    #
    # In this step we're combining three sources of data:
    # 1. sensitive configuration data retrieved from Kubernetes secrets in section II above
    # 2. Open edx application and services configuration data created here in section III
    # 3. LMS and CMS application configuration data stored in our repo at ci/tutor-deploy/environments/prod/settings_merge.json
    #------------------------------------------------------------------------
    - name: Patch Generated Configuration (Static)
      run:  |-
        echo "config.yml full path: $(tutor config printroot)/config.yml"
        cat "$(tutor config printroot)/config.yml"
        echo ""
        echo ""


        cd $TUTOR_ROOT/env/apps/openedx/config/

        mv lms.env.json lms.env.json.orig
        jq -s '.[0] * .[1]'  lms.env.json.orig  "$GITHUB_WORKSPACE/ci/tutor-deploy/environments/$ENVIRONMENT_ID/settings_merge.json" >  lms.env.json

        echo 'Tutor lms.env.json contents:'
        cat lms.env.json
        echo ""
        echo ""

        mv cms.env.json cms.env.json.orig
        jq -s '.[0] * .[1]'  cms.env.json.orig  "$GITHUB_WORKSPACE/ci/tutor-deploy/environments/$ENVIRONMENT_ID/settings_merge.json" >  cms.env.json
        rm *orig

        echo 'Tutor cms.env.json contents:'
        cat cms.env.json
        echo ""
        echo ""

    #------------------------------------------------------------------------
    # V. Deploy Open edX
    #------------------------------------------------------------------------
    - name: Deploy Tutor
      run:  |-
        tutor k8s start

    - name: Run tutor init
      run:  |-
        tutor k8s init

    - name: Set theme
      run:  |-
        tutor k8s settheme edx-theme

    - name: Create admin user
      run:  |-
        $(kubectl get secret admin-edx -n $NAMESPACE  -o json | jq  '.data | map_values(@base64d)' |   jq -r 'keys[] as $k | "export \($k|ascii_upcase)=\(.[$k])"')
        tutor k8s createuser --password "$ADMIN_PASSWORD" --staff --superuser "$ADMIN_USER" admin@mrionline.com
